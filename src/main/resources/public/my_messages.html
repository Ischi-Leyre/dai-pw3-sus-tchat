<!-- html
Fichier : `src/main/resources/public/my_messages.html`
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Messages - JitSUSmon</title>
    <script src="js/api_ui.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 1rem; }
        .msg { border: 1px solid #ddd; padding: 0.5rem; margin: 0.5rem 0; }
        .actions { margin-top: 0.5rem; }
        button { margin-right: 0.5rem; }
        pre { background:#f7f7f7; padding:0.5rem; }
    </style>
</head>
<body>
<h1>My Messages</h1>

<button id="refreshBtn">Refresh</button>
<div id="messagesList"></div>
<pre id="myMessagesOutput"></pre>

<h2>Post / Edit a Message</h2>
<form id="postMessageForm">
    <input type="hidden" name="msgId" id="msgId">
    <input name="content" id="contentInput" placeholder="Message content" required>
    <button type="submit" id="submitBtn">Post</button>
    <button type="button" id="cancelEditBtn" style="display:none;">Cancel Edit</button>
</form>

<script>
    const listEl = document.getElementById('messagesList');
    const out = id => document.getElementById(id);
    const refreshBtn = document.getElementById('refreshBtn');
    const form = document.getElementById('postMessageForm');
    const contentInput = document.getElementById('contentInput');
    const msgIdInput = document.getElementById('msgId');
    const submitBtn = document.getElementById('submitBtn');
    const cancelEditBtn = document.getElementById('cancelEditBtn');

    async function loadMessages() {
        out('myMessagesOutput').textContent = 'Loading...';
        try {
            const res = await fetch('/messages/mine', { credentials: 'same-origin' });
            const text = await res.text();
            let data;
            try { data = JSON.parse(text); } catch { data = { status: res.status, body: text }; }
            renderMessages(data);
        } catch (err) {
            out('myMessagesOutput').textContent = 'Error: ' + err.message;
        }
    }

    function renderMessages(data) {
        listEl.innerHTML = '';
        if (!Array.isArray(data)) {
            out('myMessagesOutput').textContent = JSON.stringify(data, null, 2);
            return;
        }
        if (data.length === 0) {
            listEl.textContent = 'No messages';
            out('myMessagesOutput').textContent = '';
            return;
        }
        data.forEach(msg => {
            const div = document.createElement('div');
            div.className = 'msg';
            const meta = document.createElement('div');
            meta.textContent = `#${msg.id} — ${new Date(msg.createdAt || Date.now()).toLocaleString()}`;
            const content = document.createElement('div');
            content.textContent = msg.content;
            const actions = document.createElement('div');
            actions.className = 'actions';
            const editBtn = document.createElement('button');
            editBtn.textContent = 'Éditer';
            editBtn.onclick = () => startEdit(msg);
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Supprimer';
            deleteBtn.onclick = () => deleteMessage(msg.id);
            actions.appendChild(editBtn);
            actions.appendChild(deleteBtn);

            div.appendChild(meta);
            div.appendChild(content);
            div.appendChild(actions);
            listEl.appendChild(div);
        });
        out('myMessagesOutput').textContent = '';
    }

    function startEdit(msg) {
        msgIdInput.value = msg.id;
        contentInput.value = msg.content;
        submitBtn.textContent = 'Save';
        cancelEditBtn.style.display = 'inline-block';
        contentInput.focus();
    }

    function cancelEdit() {
        msgIdInput.value = '';
        contentInput.value = '';
        submitBtn.textContent = 'Post';
        cancelEditBtn.style.display = 'none';
    }

    async function deleteMessage(id) {
        if (!confirm('Supprimer ce message ?')) return;
        try {
            const res = await fetch('/messages/' + id, { method: 'DELETE', credentials: 'same-origin' });
            if (res.ok) {
                await loadMessages();
            } else {
                const text = await res.text();
                out('myMessagesOutput').textContent = `Delete failed: ${res.status} ${text}`;
            }
        } catch (err) {
            out('myMessagesOutput').textContent = 'Error: ' + err.message;
        }
    }

    form.onsubmit = async e => {
        e.preventDefault();
        const id = msgIdInput.value;
        const content = contentInput.value.trim();
        if (!content) return;
        try {
            if (id) {
                // edit
                const res = await fetch('/messages/' + id, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({ content })
                });
                const text = await res.text();
                if (!res.ok) out('myMessagesOutput').textContent = `Update failed: ${res.status} ${text}`;
            } else {
                // create
                const res = await fetch('/messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({ content })
                });
                const text = await res.text();
                if (!res.ok) out('myMessagesOutput').textContent = `Create failed: ${res.status} ${text}`;
            }
            cancelEdit();
            await loadMessages();
        } catch (err) {
            out('myMessagesOutput').textContent = 'Error: ' + err.message;
        }
    };

    cancelEditBtn.onclick = cancelEdit;
    refreshBtn.onclick = loadMessages;

    // load initially
    loadMessages();
</script>
</body>
</html>
